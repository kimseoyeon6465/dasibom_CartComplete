<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ</title>
<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<link rel="stylesheet" href="/dasibom/CSS/kakaopay.css">

</head>
<body>
	<h1>ì¹´ì¹´ì˜¤í˜ì´ë¡œ ê²°ì œ</h1>
	<button id="kyulje">ë¹„íšŒì› í…ŒìŠ¤íŠ¸ ê²°ì œí•˜ê¸°</button>

	<script>
    document.addEventListener("DOMContentLoaded", function () {
      const btn = document.getElementById('kyulje');
      if (!btn) {
        console.error("âŒ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: #kyulje");
        return;
      }

      btn.addEventListener('click', () => {
        const IMP = window.IMP;
        IMP.init('imp22446627'); // ê°€ë§¹ì  ì‹ë³„ì½”ë“œ

        const guestRaw = localStorage.getItem("guestOrderInfo");
        const orderRaw = localStorage.getItem("orderData");

        if (!guestRaw || !orderRaw) {
          alert("ì£¼ë¬¸ ì •ë³´ ë˜ëŠ” ë¹„íšŒì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const guestOrder = JSON.parse(guestRaw);
        const orderList = JSON.parse(orderRaw);

        // âœ… sumPrice ê³„ì‚°
        let sumPrice = 0;
        orderList.forEach(item => {
          sumPrice += item.count * item.price;
        });

        // âœ… ë””ë²„ê¹… ë¡œê·¸
        console.log("ğŸ‘¤ guestOrder:", guestOrder);
        console.log("ğŸ“¦ orderList:", orderList);
        console.log("ğŸ’° ê³„ì‚°ëœ sumprice:", sumPrice);

        // âœ… ìƒí’ˆëª… êµ¬ì„±
        let productName = "ë„ì„œì£¼ë¬¸";
        if (orderList.length > 0) {
          const firstTitle = orderList[0].title || "ë„ì„œ";
          const totalCount = orderList.length;
          productName = totalCount > 1 ? `${firstTitle} ì™¸ ${totalCount - 1}ê¶Œ` : firstTitle;
        }

        const requestData = {
          pg: 'kakaopay',
          pay_method: 'card',
          merchant_uid: `order_${new Date().getTime()}`,
          name: productName,
          amount: sumPrice,
          buyer_name: guestOrder.receiver || "ë¹„íšŒì›",
          buyer_addr: guestOrder.address || "-"
        };

        const fullOrderData = {
          receiver: guestOrder.receiver,
          tel: guestOrder.tel,
          address: guestOrder.address,
          email: guestOrder.email,
          request: guestOrder.request,
          sumPrice: sumPrice,
          orderList: orderList
        };

        // âœ… context path ìë™ ì¶”ì¶œ
        const contextPath = "/" + window.location.pathname.split("/")[1];

        // âœ… ê²°ì œ ìš”ì²­ ë¡œê·¸
        console.log("ğŸ“¤ ì¹´ì¹´ì˜¤í˜ì´ ìš”ì²­ ë°ì´í„°:", requestData);

        IMP.request_pay(requestData, (rsp) => {
          if (rsp.success) {
            alert(`âœ… ê²°ì œ ì™„ë£Œ! ê²°ì œê¸ˆì•¡: ${rsp.paid_amount}ì›`);
            console.log("âœ… ê²°ì œ ì‘ë‹µ:", rsp);

            // ì£¼ë¬¸ ì •ë³´ ì„œë²„ë¡œ ì „ì†¡
            fetch("/dasibom/guestOrder.do", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(fullOrderData)
            })
              .then(res => {
                if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
                return res.json();
              })
              .then(data => {
                console.log("âœ… ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);
                if (data.result === "success") {
                  location.href = contextPath + "/guestPaymentComplete.do";
                } else {
                  alert("âŒ ì£¼ë¬¸ ì²˜ë¦¬ ì‹¤íŒ¨: " + JSON.stringify(data));
                }
              })
              .catch(err => {
                console.error("âŒ ì„œë²„ ì²˜ë¦¬ ì˜¤ë¥˜:", err);
                alert("ì„œë²„ ì˜¤ë¥˜:\n" + err.message);
              });

          } else {
            alert(`âŒ ê²°ì œ ì‹¤íŒ¨: ${rsp.error_msg}`);
            console.error("âŒ ê²°ì œ ì‹¤íŒ¨ ì‘ë‹µ:", rsp);
          }
        });
      });
    });
  </script>
</body>
</html>
